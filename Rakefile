require 'yaml'
require 'rake/clean'
Dir.glob( './scripts/**/*.rake' ).each { |rake_ext| import rake_ext }

# rake defaults
desc 'Build hotaru.elf'
task :default => 'hotaru.elf'

# collect sources and options files
SOURCES    = FileList.new( 'src/**/*.c', 'src/**/*.S' )
SOURCES_64 = FileList.new( SOURCES )
SOURCES_32 = FileList.new
OBJECTS    = SOURCES.ext( '.o' )

# split sources into 64bit and 32bit
Dir.glob( 'src/**/options.yaml' ).each do |option_file|
  { :sources_32 => [] }.merge( YAML::load_file( option_file ) )[ :sources_32 ].each do |src|
    SOURCES_32 << SOURCES_64.delete( "#{File.dirname( option_file )}/#{src}" )
  end
end

# file targets for kernel and *.o
file 'hotaru.elf' => [ *OBJECTS, 'Rakefile', 'scripts/link.ld' ] do |t|
  cc_link( OBJECTS, t.name.ext( '.elf64' ) )
  cc_64to32( t.name.ext( '.elf64' ), t.name, :cleanup => false )
end

SOURCES_64.each do |src|
  file src.ext( '.o' ) => [ src, 'Rakefile' ] do |t|
    cc_compile( src, t.name )
  end
end

SOURCES_32.each do |src|
  file src.ext( '.o' ) => [ src, 'Rakefile' ] do |t|
    cc_compile( src, t.name, :use32 => true )
  end
end

# include autogenerated depends
file '.depends.rake' => SOURCES do
  puts "Updating rake depends.."
  cc_rakedeps( SOURCES, '.depends.rake')
end

import '.depends.rake'

CLEAN   << OBJECTS   \
        << '*.o32'   \
        << '*.o64'   \
        << '*.elf32' \
        << '*.elf64' \

CLOBBER << '.depends.rake' \
        << 'hotaru.elf'    \
        << 'Symbols.map'

